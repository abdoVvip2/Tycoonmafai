<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ù„Ø¯ÙŠÙˆØ§Ù† Ø§Ù„Ù…Ù„ÙƒÙŠ | Ø§Ù„Ù…Ø±Ø§Ø³Ù„Ø§Øª Ø§Ù„Ø³ÙŠØ§Ø¯ÙŠØ©</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root { 
            --gold: #d4af37; 
            --gold-bright: #f1d592; 
            --card: rgba(22, 27, 34, 0.95); 
            --border-gold: rgba(212, 175, 55, 0.3);
            --red: #ef4444;
            --green: #22c55e;
        }
        body { margin: 0; font-family: 'Cairo', sans-serif; background: #0b101b; color: #e6edf3; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        .royal-header { padding: 20px; background: var(--card); border-bottom: 1px solid var(--border-gold); display: flex; justify-content: space-between; align-items: center; }
        .royal-header h1 { margin: 0; font-size: 1.4rem; color: var(--gold); }
        .nav-tabs { display: flex; background: rgba(0,0,0,0.5); padding: 8px; margin: 15px; border-radius: 20px; border: 1px solid var(--border-gold); gap: 5px; }
        .tab-btn { flex: 1; padding: 12px 5px; border: none; background: none; color: #8b949e; font-family: 'Cairo'; font-weight: bold; cursor: pointer; border-radius: 15px; font-size: 0.9rem; transition: 0.3s; }
        .tab-btn.active { background: var(--gold); color: #000; }
        .scroll-area { flex: 1; overflow-y: auto; padding: 0 15px 100px 15px; }
        .mail-card { background: var(--card); border: 1px solid var(--border-gold); border-radius: 20px; padding: 20px; margin-bottom: 16px; cursor: pointer; position: relative; box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
        .mail-card.unread { border-right: 6px solid var(--gold); }
        .status-badge { position: absolute; top: 15px; left: 15px; padding: 4px 10px; border-radius: 8px; font-size: 0.75rem; font-weight: bold; }
        .status-pending { background: rgba(59, 130, 246, 0.2); color: #3b82f6; }
        .status-accepted { background: rgba(34, 197, 94, 0.2); color: var(--green); }
        .status-rejected { background: rgba(239, 68, 68, 0.2); color: var(--red); }
        .luxury-box { background: var(--card); border-radius: 20px; padding: 20px; border: 1px solid var(--border-gold); margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; color: var(--gold); font-weight: bold; font-size: 0.9rem; }
        select, input { width: 100%; padding: 14px; background: #0f172a; border: 1px solid var(--border-gold); border-radius: 12px; color: white; font-family: 'Cairo'; margin-bottom: 15px; box-sizing: border-box; }
        .btn-prime { width: 100%; padding: 16px; border: none; border-radius: 15px; font-weight: 900; cursor: pointer; font-family: 'Cairo'; font-size: 1.1rem; transition: 0.2s; }
        .btn-gold { background: var(--gold); color: #000; }
        .btn-gold:active { transform: scale(0.98); }
        .bottom-bar { position: fixed; bottom: 0; width: 100%; height: 75px; background: #050505; border-top: 1px solid var(--border-gold); display: flex; justify-content: space-around; align-items: center; z-index: 100; }
        .nav-link { text-decoration: none; text-align: center; color: #666; font-size: 0.8rem; }
        .nav-link.active { color: var(--gold); }
        #msg-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 1000; display: none; align-items: center; justify-content: center; padding: 20px; }
        .modal-content { background: #161b22; width: 100%; max-width: 500px; border-radius: 25px; border: 2px solid var(--gold); padding: 25px; max-height: 85vh; overflow-y: auto; }
        .view { display: none; }
        .view.active { display: block; }
    </style>
</head>
<body>

    <header class="royal-header">
        <h1>ğŸ›ï¸ Ø§Ù„Ø¯ÙŠÙˆØ§Ù† Ø§Ù„Ø±Ø¦Ø§Ø³ÙŠ</h1>
        <div id="balance-display" style="color:var(--gold-bright); font-weight:900; font-size:1.2rem;">$0</div>
    </header>

    <div class="nav-tabs">
        <button class="tab-btn active" onclick="showTab('inbox', this)">ğŸ“¥ Ø§Ù„ÙˆØ§Ø±Ø¯</button>
        <button class="tab-btn" onclick="showTab('sent', this)">ğŸ“¤ Ø§Ù„Ø¹Ø±ÙˆØ¶ Ø§Ù„ØµØ§Ø¯Ø±Ø©</button>
        <button class="tab-btn" onclick="showTab('actions', this)">ğŸ¤ Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ø±Ø¶</button>
    </div>

    <div class="scroll-area">
        <div id="view-inbox" class="view active">
            <div id="mail-container"></div>
        </div>

        <div id="view-sent" class="view">
            <div id="sent-container"></div>
        </div>

        <div id="view-actions" class="view">
            <div class="luxury-box">
                <label>Ù†Ø­Ù† Ù†Ù‚Ø¯Ù… Ù„Ù„Ø¯ÙˆÙ„Ø© Ø§Ù„Ø£Ø®Ø±Ù‰:</label>
                <input type="number" id="offer-qty" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ© (Ù…Ø«Ù„Ø§Ù‹: 1000)">
                <select id="offer-res">
                    <option value="balance">ğŸ’° Ø±ØµÙŠØ¯ Ù…Ø§Ù„ÙŠ</option>
                    <option value="power">âš¡ Ø·Ø§Ù‚Ø© ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠØ©</option>
                    <option value="bread">ğŸ Ù…Ø®Ø²ÙˆÙ† Ø®Ø¨Ø²</option>
                    <option value="oil">ğŸ›¢ï¸ Ù†ÙØ· Ø®Ø§Ù…</option>
                    <option value="fuel">â›½ ÙˆÙ‚ÙˆØ¯ Ù…ØµÙÙ‰</option>
                    <option value="wheat">ğŸŒ¾ Ù‚Ù…Ø­</option>
                </select>

                <label>Ù†Ø·Ù„Ø¨ Ù…Ù†Ù‡Ù… Ø¨Ø§Ù„Ù…Ù‚Ø§Ø¨Ù„:</label>
                <input type="number" id="request-qty" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©">
                <select id="request-res">
                    <option value="balance">ğŸ’° Ø±ØµÙŠØ¯ Ù…Ø§Ù„ÙŠ</option>
                    <option value="power">âš¡ Ø·Ø§Ù‚Ø© ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠØ©</option>
                    <option value="bread">ğŸ Ù…Ø®Ø²ÙˆÙ† Ø®Ø¨Ø²</option>
                    <option value="oil">ğŸ›¢ï¸ Ù†ÙØ· Ø®Ø§Ù…</option>
                    <option value="fuel">â›½ ÙˆÙ‚ÙˆØ¯ Ù…ØµÙÙ‰</option>
                    <option value="wheat">ğŸŒ¾ Ù‚Ù…Ø­</option>
                </select>

                <label>Ø§Ù„Ø­Ø§ÙƒÙ… Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù Ø¨Ø§Ù„Ø¹Ø±Ø¶:</label>
                <select id="player-list"><option value="">Ø§Ø®ØªØ± Ø§Ù„Ø­Ø§ÙƒÙ…...</option></select>
                
                <button class="btn-prime btn-gold" onclick="sendTradeOffer()">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø¯Ø¨Ù„ÙˆÙ…Ø§Ø³ÙŠ</button>
            </div>
        </div>
    </div>

    <div id="msg-modal">
        <div class="modal-content">
            <h2 id="m-subject" style="color:var(--gold-bright); text-align:center;"></h2>
            <div id="m-body" style="line-height:1.8; white-space: pre-wrap; margin: 20px 0; font-size: 1.1rem; background: rgba(0,0,0,0.3); padding: 15px; border-radius: 10px;"></div>
            <div id="trade-actions" style="display:none; gap:10px;">
                <button id="btn-accept" class="btn-prime" style="background:var(--green); color:white; flex:1;">Ù‚Ø¨ÙˆÙ„ âœ…</button>
                <button id="btn-reject" class="btn-prime" style="background:var(--red); color:white; flex:1;">Ø±ÙØ¶ âŒ</button>
            </div>
            <button class="btn-prime" onclick="closeMessage()" style="margin-top:15px; background:#334155; color:white;">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
    </div>

    <div class="bottom-bar">
        <a href="consol.html" class="nav-link">ğŸ <br>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
        <a href="mail.html" class="nav-link active">ğŸ“©<br>Ø§Ù„Ø¨Ø±ÙŠØ¯</a>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, updateDoc, collection, getDocs, onSnapshot, arrayUnion } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDIxOZ_zEKosBgJD2Thn038BFpM25rVGcc",
            authDomain: "tycoon-c3b89.firebaseapp.com",
            projectId: "tycoon-c3b89",
            storageBucket: "tycoon-c3b89.firebasestorage.app",
            messagingSenderId: "534437445544",
            appId: "1:534437445544:web:5f7ea5396367e6b5cca79d"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        let userRef, userData;

        const resNames = { balance: "ğŸ’° Ø¯ÙˆÙ„Ø§Ø±", power: "âš¡ Ø·Ø§Ù‚Ø©", bread: "ğŸ Ø®Ø¨Ø²", oil: "ğŸ›¢ï¸ Ù†ÙØ·", fuel: "â›½ ÙˆÙ‚ÙˆØ¯", wheat: "ğŸŒ¾ Ù‚Ù…Ø­" };

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userRef = doc(db, "players", user.uid);
                onSnapshot(userRef, (snap) => {
                    userData = snap.data();
                    document.getElementById('balance-display').innerText = "$" + (userData.balance || 0).toLocaleString("en-US");
                    renderInbox();
                    renderSent();
                });
                loadPlayers();
            } else { window.location.href = 'home.html'; }
        });

        async function loadPlayers() {
            const snap = await getDocs(collection(db, "players"));
            const list = document.getElementById('player-list');
            list.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ø­Ø§ÙƒÙ…...</option>';
            snap.forEach(d => {
                if(d.id !== auth.currentUser.uid) {
                    let opt = document.createElement('option');
                    opt.value = d.id;
                    opt.innerText = `Ø¯ÙˆÙ„Ø© ${d.data().countryName || d.data().presidentName}`;
                    list.appendChild(opt);
                }
            });
        }

        function renderInbox() {
            const cont = document.getElementById('mail-container');
            cont.innerHTML = "";
            const msgs = userData.messages || [];
            if(msgs.length === 0) cont.innerHTML = "<p style='text-align:center; opacity:0.5; margin-top:50px;'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ø±Ù‚ÙŠØ§Øª ÙˆØ§Ø±Ø¯Ø©</p>";
            msgs.slice().reverse().forEach((m, i) => {
                let card = document.createElement('div');
                card.className = `mail-card ${m.unread ? 'unread' : ''}`;
                card.onclick = () => openMessage(msgs.length - 1 - i);
                card.innerHTML = `<strong>${m.sender}</strong><br><small>${m.sub}</small>`;
                cont.appendChild(card);
            });
        }

        function renderSent() {
            const cont = document.getElementById('sent-container');
            cont.innerHTML = "";
            const sent = userData.sentOffers || [];
            if(sent.length === 0) cont.innerHTML = "<p style='text-align:center; opacity:0.5; margin-top:50px;'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ø±ÙˆØ¶ ØµØ§Ø¯Ø±Ø© Ø­Ø§Ù„ÙŠØ§Ù‹</p>";
            sent.slice().reverse().forEach(o => {
                let badge = o.status === 'pending' ? 'status-pending' : (o.status === 'accepted' ? 'status-accepted' : 'status-rejected');
                let statusTxt = o.status === 'pending' ? 'Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±' : (o.status === 'accepted' ? 'ØªÙ… Ø§Ù„Ù‚Ø¨ÙˆÙ„' : 'ØªÙ… Ø§Ù„Ø±ÙØ¶');
                let card = document.createElement('div');
                card.className = "mail-card";
                card.innerHTML = `<span class="status-badge ${badge}">${statusTxt}</span><strong>Ø¥Ù„Ù‰: ${o.targetName}</strong><br><small>Ø¹Ø±Ø¶: ${o.oQty} ${resNames[o.oRes]} Ù…Ù‚Ø§Ø¨Ù„ ${o.rQty} ${resNames[o.rRes]}</small>`;
                cont.appendChild(card);
            });
        }

        window.sendTradeOffer = async () => {
            const targetId = document.getElementById('player-list').value;
            const targetName = document.getElementById('player-list').options[document.getElementById('player-list').selectedIndex].text;
            const oQty = parseInt(document.getElementById('offer-qty').value);
            const oRes = document.getElementById('offer-res').value;
            const rQty = parseInt(document.getElementById('request-qty').value);
            const rRes = document.getElementById('request-res').value;

            if(!targetId || isNaN(oQty) || isNaN(rQty)) return alert("ÙŠØ±Ø¬Ù‰ Ø¥ÙƒÙ…Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ø±Ø¶");
            if(userData[oRes] < oQty) return alert("Ù…Ø®Ø²ÙˆÙ†Ùƒ Ù„Ø§ ÙŠÙƒÙÙŠ Ù„Ø¥Ø±Ø³Ø§Ù„ Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø±Ø¶!");

            const tradeId = "T-" + Date.now();
            const msg = { tradeId, sender: userData.countryName, senderId: auth.currentUser.uid, sub: "ğŸ¤ Ø¹Ø±Ø¶ ØªØ¬Ø§Ø±ÙŠ Ø¬Ø¯ÙŠØ¯", body: `Ø¯ÙˆÙ„Ø© ${userData.countryName} ØªÙ‚ØªØ±Ø­ ØªØ¨Ø§Ø¯Ù„:\nÙ†Ù‚Ø¯Ù… Ù„ÙƒÙ…: ${oQty.toLocaleString()} Ù…Ù† ${resNames[oRes]}\nÙ†Ø·Ù„Ø¨ Ù…Ù†ÙƒÙ…: ${rQty.toLocaleString()} Ù…Ù† ${resNames[rRes]}`, type: 'trade', oRes, oQty, rRes, rQty, unread: true, processed: false };
            const myRecord = { tradeId, targetId, targetName, oRes, oQty, rRes, rQty, status: 'pending' };

            await updateDoc(doc(db, "players", targetId), { messages: arrayUnion(msg) });
            await updateDoc(userRef, { sentOffers: arrayUnion(myRecord) });
            alert("âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¹Ø±Ø¶ Ø¨Ù†Ø¬Ø§Ø­!");
            showTab('sent', document.querySelector('.tab-btn:nth-child(2)'));
        };

        window.openMessage = async (idx) => {
            const m = userData.messages[idx];
            document.getElementById('m-subject').innerText = m.sub;
            document.getElementById('m-body').innerText = m.body;
            document.getElementById('msg-modal').style.display = 'flex';
            const actions = document.getElementById('trade-actions');
            
            if(m.type === 'trade' && !m.processed) {
                actions.style.display = 'flex';
                document.getElementById('btn-accept').onclick = () => processTrade(idx, 'accepted');
                document.getElementById('btn-reject').onclick = () => processTrade(idx, 'rejected');
            } else { actions.style.display = 'none'; }

            if(m.unread) {
                userData.messages[idx].unread = false;
                await updateDoc(userRef, { messages: userData.messages });
            }
        };

        async function processTrade(idx, status) {
            const m = userData.messages[idx];
            const senderRef = doc(db, "players", m.senderId);
            const senderSnap = await getDoc(senderRef);
            const senderData = senderSnap.data();

            if(status === 'accepted') {
                if(userData[m.rRes] < m.rQty) return alert("Ù„Ø§ ØªÙ…Ù„Ùƒ Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ù„Ù„Ù‚Ø¨ÙˆÙ„!");
                if(senderData[m.oRes] < m.oQty) return alert("Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø± Ù„Ù… ÙŠØ¹Ø¯ ÙŠÙ…Ù„Ùƒ Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶Ø©!");

                let upMy = { [m.rRes]: userData[m.rRes] - m.rQty, [m.oRes]: (userData[m.oRes] || 0) + m.oQty };
                let upHis = { [m.oRes]: senderData[m.oRes] - m.oQty, [m.rRes]: (senderData[m.rRes] || 0) + m.rQty };
                await updateDoc(userRef, upMy);
                await updateDoc(senderRef, upHis);
            }

            userData.messages[idx].processed = true;
            userData.messages[idx].body += `\n\n[ØªÙ… ${status === 'accepted' ? 'Ù‚Ø¨ÙˆÙ„' : 'Ø±ÙØ¶'} Ø§Ù„Ø¹Ø±Ø¶]`;
            await updateDoc(userRef, { messages: userData.messages });

            const hisOffers = senderData.sentOffers.map(o => o.tradeId === m.tradeId ? {...o, status} : o);
            await updateDoc(senderRef, { sentOffers: hisOffers });

            alert(status === 'accepted' ? "âœ… ØªÙ…Øª Ø§Ù„ØµÙÙ‚Ø©!" : "âŒ ØªÙ… Ø§Ù„Ø±ÙØ¶");
            closeMessage();
        }

        window.showTab = (id, btn) => {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(t => t.classList.remove('active'));
            document.getElementById('view-' + id).classList.add('active');
            btn.classList.add('active');
        };

        window.closeMessage = () => document.getElementById('msg-modal').style.display = 'none';
    </script>
</body>
</html>```
