<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ù„Ø¯ÙŠÙˆØ§Ù† Ø§Ù„Ù…Ù„ÙƒÙŠ | Ø§Ù„Ù…Ø±Ø§Ø³Ù„Ø§Øª Ø§Ù„Ø³ÙŠØ§Ø¯ÙŠØ©</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root { 
            --gold: #d4af37; 
            --gold-bright: #f1d592; 
            --card: rgba(22, 27, 34, 0.95); 
            --border-gold: rgba(212, 175, 55, 0.3);
        }
        
        body {
            margin: 0; font-family: 'Cairo', sans-serif; 
            background: linear-gradient(rgba(0,0,0,0.9), rgba(0,0,0,0.9)), 
                        url('https://images.unsplash.com/photo-1497366216548-37526070297c?q=80&w=2000&auto=format&fit=crop');
            background-size: cover; background-attachment: fixed;
            color: #e6edf3; height: 100vh; display: flex; flex-direction: column; overflow: hidden;
            touch-action: manipulation;
        }

        .royal-header {
            padding: 20px; background: var(--card);
            border-bottom: 1px solid var(--border-gold); display: flex; justify-content: space-between; align-items: center;
            backdrop-filter: blur(10px);
        }
        .royal-header h1 { margin: 0; font-size: 1.4rem; color: var(--gold); }

        .nav-tabs { display: flex; background: rgba(0,0,0,0.5); padding: 8px; margin: 15px; border-radius: 20px; border: 1px solid var(--border-gold); }
        .tab-btn {
            flex: 1; padding: 16px; border: none; background: none; color: #8b949e;
            font-family: 'Cairo'; font-weight: bold; cursor: pointer; transition: 0.3s; border-radius: 15px; font-size: 1.1rem;
        }
        .tab-btn.active { background: var(--gold); color: #000; }

        .scroll-area { flex: 1; overflow-y: auto; padding: 0 15px 100px 15px; -webkit-overflow-scrolling: touch; }
        .view { display: none; animation: fadeIn 0.4s ease; }
        .view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .mail-card {
            background: var(--card); border: 1px solid var(--border-gold); border-radius: 20px;
            padding: 20px; margin-bottom: 16px; cursor: pointer; transition: 0.3s; box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            position: relative;
        }
        .mail-card.unread { border-right: 6px solid var(--gold); background: rgba(212, 175, 55, 0.08); }
        .mail-card .sender {
            color: var(--gold-bright); font-size: 1.3rem; font-weight: bold; display: block; margin-bottom: 8px;
        }
        .mail-card .subject {
            margin: 0; font-size: 1.1rem; color: #e6edf3; line-height: 1.4;
        }

        .luxury-box { 
            background: var(--card); border-radius: 20px; padding: 24px; 
            border: 1px solid var(--border-gold); margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .luxury-box label { display: block; margin-bottom: 14px; font-size: 1.1rem; color: var(--gold); font-weight: bold; }

        select, input[type=number], input[type=text], textarea {
            width: 100%; padding: 16px; background: rgba(0,0,0,0.4); border: 1px solid var(--border-gold);
            border-radius: 15px; color: white; font-family: 'Cairo'; margin-bottom: 16px; box-sizing: border-box; font-size: 1.1rem;
        }

        .btn-prime {
            width: 100%; padding: 18px; border: none; border-radius: 15px; 
            font-weight: 900; font-family: 'Cairo'; cursor: pointer; transition: 0.3s; font-size: 1.2rem; margin-top: 10px;
        }
        .btn-gold { background: var(--gold); color: #000; box-shadow: 0 6px 20px rgba(212, 175, 55, 0.3); }
        .btn-spy { background: #3e1616; color: #ff7b72; border: 1px solid #6e2121; }

        .resource-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 14px; margin-bottom: 10px;
        }

        .bottom-bar {
            position: fixed; bottom: 0; width: 100%; height: 85px;
            background: rgba(5,5,5,0.95); border-top: 1px solid var(--border-gold);
            display: flex; justify-content: space-around; align-items: center; backdrop-filter: blur(10px);
        }
        .nav-link { text-decoration: none; text-align: center; color: #666; flex: 1; font-size: 1rem; }
        .nav-link.active { color: var(--gold); text-shadow: 0 0 12px var(--gold); }
        .nav-link small { display: block; font-size: 0.8rem; margin-top: 4px; }

        #msg-modal {
            position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 1000;
            display: none; align-items: center; justify-content: center; padding: 20px;
        }
        .modal-content {
            background: #161b22; width: 100%; max-width: 500px; border-radius: 25px;
            border: 2px solid var(--gold); padding: 30px; position: relative; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .close-modal { position: absolute; top: 15px; left: 15px; color: var(--gold); font-size: 1.8rem; cursor: pointer; }

        .message-body {
            line-height: 1.9; font-size: 1.1rem; white-space: pre-wrap; margin: 20px 0;
        }
        .message-body strong { 
            color: var(--gold-bright); font-weight: 900; font-size: 1.4em; display: block; margin: 20px 0 15px; text-align: center;
        }
        .message-body em { 
            color: var(--gold); font-style: normal; font-weight: bold; font-size: 1.6em; display: block; margin: 25px 0; text-align: center; text-shadow: 0 0 10px var(--gold);
        }

        #reply-section {
            margin-top: 25px; padding-top: 25px; border-top: 1px solid var(--border-gold);
        }
        #reply-input { height: 130px; resize: none; }

        #monopoly-status {
            background: rgba(0,0,0,0.5); padding: 18px; border-radius: 15px; 
            min-height: 80px; text-align: center; font-size: 1rem; margin-top: 10px;
        }
    </style>
</head>
<body>

    <header class="royal-header">
        <h1>ğŸ›ï¸ Ø§Ù„Ø¯ÙŠÙˆØ§Ù† Ø§Ù„Ø±Ø¦Ø§Ø³ÙŠ</h1>
        <div id="balance-display" style="color:var(--gold-bright); font-weight:bold; font-size:1.5rem;">$0</div>
    </header>

    <div class="nav-tabs">
        <button class="tab-btn active" onclick="showTab('inbox', this)">ğŸ“¥ Ø§Ù„ÙˆØ§Ø±Ø¯</button>
        <button class="tab-btn" onclick="showTab('actions', this)">ğŸ›¡ï¸ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø³ÙŠØ§Ø¯ÙŠØ©</button>
    </div>

    <div class="scroll-area">
        <div id="view-inbox" class="view active">
            <div id="mail-container"></div>
        </div>

        <div id="view-actions" class="view">
            <div class="luxury-box">
                <label>ğŸ•µï¸ Ø¬Ù‡Ø§Ø² Ø§Ù„Ù…Ø®Ø§Ø¨Ø±Ø§Øª (Ø§Ù„ØªÙƒÙ„ÙØ©: $50000)</label>
                <select id="spy-list"><option value="">Ø§Ø®ØªØ± Ø¯ÙˆÙ„Ø© Ù„Ø§Ø³ØªÙ‡Ø¯Ø§ÙÙ‡Ø§...</option></select>
                <button class="btn-prime btn-spy" onclick="executeSpy()">Ø¨Ø¯Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø§Ø®ØªØ±Ø§Ù‚</button>
            </div>

            <div class="luxury-box">
                <label>ğŸ¤ ØªØ¨Ø§Ø¯Ù„ ØªØ¬Ø§Ø±ÙŠ Ø¯Ø¨Ù„ÙˆÙ…Ø§Ø³ÙŠ</label>
                
                <div class="resource-grid">
                    <div>
                        <small style="color:var(--gold);">Ù†Ø­Ù† Ù†Ù‚Ø¯Ù…:</small>
                        <input type="number" id="offer-qty" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ© Ø£Ùˆ Ø§Ù„Ù…Ø¨Ù„Øº $" min="1">
                        <select id="offer-res">
                            <option value="money">ğŸ’° Ù†Ù‚ÙˆØ¯</option>
                            <option value="power">âš¡ Ø·Ø§Ù‚Ø©</option>
                            <option value="oil">ğŸ›¢ï¸ Ù†ÙØ·</option>
                            <option value="wheat">ğŸŒ¾ Ù‚Ù…Ø­</option>
                            <option value="fuel">â›½ ÙˆÙ‚ÙˆØ¯</option>
                            <option value="bread">ğŸ Ø®Ø¨Ø²</option>
                        </select>
                    </div>
                    <div>
                        <small style="color:var(--gold);">Ù†Ø·Ù„Ø¨ Ù…Ù‚Ø§Ø¨Ù„Ù‡Ø§:</small>
                        <input type="number" id="request-qty" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ© Ø£Ùˆ Ø§Ù„Ù…Ø¨Ù„Øº $" min="1">
                        <select id="request-res">
                            <option value="money">ğŸ’° Ù†Ù‚ÙˆØ¯</option>
                            <option value="oil">ğŸ›¢ï¸ Ù†ÙØ·</option>
                            <option value="fuel">â›½ ÙˆÙ‚ÙˆØ¯</option>
                            <option value="bread">ğŸ Ø®Ø¨Ø²</option>
                            <option value="power">âš¡ Ø·Ø§Ù‚Ø©</option>
                            <option value="wheat">ğŸŒ¾ Ù‚Ù…Ø­</option>
                        </select>
                    </div>
                </div>
                
                <label>Ø§Ù„Ø·Ø±Ù Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù:</label>
                <select id="player-list"><option value="">Ø§Ø®ØªØ± Ø§Ù„Ø±Ø¦ÙŠØ³...</option></select>
                
                <button class="btn-prime btn-gold" onclick="sendTradeOffer()">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ù…ÙŠ</button>
            </div>

            <div class="luxury-box">
                <label>ğŸ” Ù…ÙƒØ§ÙØ­Ø© Ø§Ù„Ø§Ø­ØªÙƒØ§Ø± Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ©</label>
                <p style="font-size: 0.95rem; color: #ccc; margin-bottom: 15px;">
                    ÙŠØªÙ… Ø§Ù„ÙØ­Øµ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ ÙƒÙ„ ÙŠÙˆÙ… Ø§Ù„Ø³Ø§Ø¹Ø© 00:00 Ø¨ØªÙˆÙ‚ÙŠØª Ø§Ù„Ø¬Ø²Ø§Ø¦Ø±.<br>
                    Ø¢Ø®Ø± ØªÙ‚Ø±ÙŠØ± Ø³ÙŠØ¸Ù‡Ø± Ù‡Ù†Ø§.
                </p>
                <div id="monopoly-status">Ø³ÙŠØªÙ… Ø§Ù„ÙØ­Øµ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø§Ù„Ø³Ø§Ø¹Ø© 00:00 Ø¨ØªÙˆÙ‚ÙŠØª Ø§Ù„Ø¬Ø²Ø§Ø¦Ø±.</div>
            </div>
        </div>
    </div>

    <div id="msg-modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeMessage()">âœ•</span>
            <small id="m-sender" style="color:var(--gold); font-size:1.2rem;"></small>
            <h2 id="m-subject" style="margin: 15px 0; color:var(--gold-bright); font-size:1.4rem;"></h2>
            <div id="m-body" class="message-body"></div>

            <div id="reply-section">
                <textarea id="reply-input" placeholder="Ø§ÙƒØªØ¨ Ø±Ø¯Ùƒ Ø§Ù„Ø±Ø³Ù…ÙŠ Ù‡Ù†Ø§..."></textarea>
                <button class="btn-prime btn-gold" onclick="sendReply()">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø¯</button>
            </div>
        </div>
    </div>

    <div class="bottom-bar">
        <a href="consol.html" class="nav-link">ğŸ <small>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</small></a>
        <a href="market.html" class="nav-link">ğŸ“ˆ<small>Ø§Ù„Ø¨ÙˆØ±ØµØ©</small></a>
        <a href="mail.html" class="nav-link active">ğŸ“©<small>Ø§Ù„Ø¨Ø±ÙŠØ¯</small></a>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, updateDoc, collection, getDocs, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDIxOZ_zEKosBgJD2Thn038BFpM25rVGcc",
            authDomain: "tycoon-c3b89.firebaseapp.com",
            projectId: "tycoon-c3b89",
            storageBucket: "tycoon-c3b89.firebasestorage.app",
            messagingSenderId: "534437445544",
            appId: "1:534437445544:web:5f7ea5396367e6b5cca79d"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        let userRef, userData;

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userRef = doc(db, "players", user.uid);
                onSnapshot(userRef, (snap) => {
                    userData = snap.data();
                    document.getElementById('balance-display').innerText = "$" + (userData.balance || 0).toLocaleString("en-US");
                    renderMails();
                });

                await loadGlobalData();
            } else {
                window.location.href = 'home.html';
            }
        });

        async function loadGlobalData() {
            const snap = await getDocs(collection(db, "players"));
            const playerList = document.getElementById('player-list');
            const spyList = document.getElementById('spy-list');

            playerList.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ø±Ø¦ÙŠØ³...</option>';
            spyList.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø¯ÙˆÙ„Ø© Ù„Ø§Ø³ØªÙ‡Ø¯Ø§ÙÙ‡Ø§...</option>';

            snap.forEach((docSnap) => {
                if (docSnap.id !== auth.currentUser?.uid) {
                    const data = docSnap.data();
                    const displayName = data.countryName || data.presidentName || "Ø¯ÙˆÙ„Ø© Ù…Ø¬Ù‡ÙˆÙ„Ø©";

                    const option = document.createElement('option');
                    option.value = docSnap.id;
                    option.textContent = displayName;

                    playerList.appendChild(option.cloneNode(true));
                    spyList.appendChild(option);
                }
            });
        }

        function renderMails() {
            const container = document.getElementById('mail-container');
            if (!userData.messages || userData.messages.length === 0) {
                container.innerHTML = "<p style='text-align:center; color:#666; margin-top:80px; font-size:1.2rem;'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ø±Ù‚ÙŠØ§Øª Ø­Ø§Ù„ÙŠØ§Ù‹</p>";
                return;
            }

            container.innerHTML = "";
            userData.messages.slice().reverse().forEach((m, i) => {
                const div = document.createElement('div');
                div.className = `mail-card ${m.unread ? 'unread' : ''}`;
                div.onclick = () => openMessage(i);
                div.innerHTML = `
                    <span class="sender">${m.sender || "Ù…Ø¬Ù‡ÙˆÙ„"}</span>
                    <p class="subject">${m.sub || "(Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†)"}</p>
                `;
                container.appendChild(div);
            });
        }

        window.openMessage = async (i) => {
            const index = userData.messages.length - 1 - i;
            const m = userData.messages[index];

            document.getElementById('m-sender').innerText = m.sender || "Ù…Ø¬Ù‡ÙˆÙ„";
            document.getElementById('m-subject').innerText = m.sub || "(Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†)";

            let body = m.body || "(Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†Øµ)";
            body = body.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                       .replace(/\*\*\*\*(.*?)\*\*\*\*/g, '<em>$1</em>');

            document.getElementById('m-body').innerHTML = body;
            document.getElementById('msg-modal').style.display = 'flex';
            document.getElementById('reply-input').value = '';

            if (m.unread) {
                userData.messages[index].unread = false;
                await updateDoc(userRef, { messages: userData.messages });
            }
        };

        window.sendReply = async () => {
            const text = document.getElementById('reply-input').value.trim();
            if (!text) return alert("Ø§ÙƒØªØ¨ Ø§Ù„Ø±Ø¯ Ø£ÙˆÙ„Ø§Ù‹");

            const replyMsg = {
                sender: `Ø¯ÙˆÙ„Ø© ${userData.countryName || userData.presidentName || "Ø§Ù„Ù„Ø§Ø¹Ø¨"}`,
                sub: "Ø±Ø¯ Ø±Ø³Ù…ÙŠ",
                body: text,
                unread: false
            };

            await updateDoc(userRef, { messages: [replyMsg, ...userData.messages] });
            alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø±Ø¯ ÙÙŠ Ø¨Ø±ÙŠØ¯Ùƒ");
            closeMessage();
            renderMails();
        };

        // Ø¯Ø§Ù„Ø© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªØ¬Ø§Ø±ÙŠ (Ù…ÙØµÙ„Ø­Ø© ØªÙ…Ø§Ù…Ù‹Ø§ - Ø¨Ø¯ÙˆÙ† Ø£ÙŠ syntax error)
        window.sendTradeOffer = async () => {
            const offerQty = parseInt(document.getElementById('offer-qty').value);
            const offerType = document.getElementById('offer-res').value;
            const requestQty = parseInt(document.getElementById('request-qty').value);
            const requestType = document.getElementById('request-res').value;
            const targetId = document.getElementById('player-list').value;

            if (!targetId) return alert("Ø§Ø®ØªØ± Ø¯ÙˆÙ„Ø© Ù…Ø³ØªÙ‡Ø¯ÙØ© Ø£ÙˆÙ„Ø§Ù‹");
            if (isNaN(offerQty) || offerQty <= 0 || isNaN(requestQty) || requestQty <= 0) {
                return alert("Ø£Ø¯Ø®Ù„ ÙƒÙ…ÙŠØ§Øª Ø£Ùˆ Ù…Ø¨Ø§Ù„Øº ØµØ­ÙŠØ­Ø© ÙˆØ£ÙƒØ¨Ø± Ù…Ù† ØµÙØ±");
            }

            const offerOption = document.querySelector('#offer-res option[value="' + offerType + '"]');
            const requestOption = document.querySelector('#request-res option[value="' + requestType + '"]');

            const offerText = offerType === "money" 
                ? `\[ {offerQty.toLocaleString("en-US")}` 
                : `${offerQty.toLocaleString("en-US")} ${offerOption ? offerOption.textContent : offerType}`;

            const requestText = requestType === "money" 
                ? ` \]{requestQty.toLocaleString("en-US")}` 
                : `${requestQty.toLocaleString("en-US")} ${requestOption ? requestOption.textContent : requestType}`;

            const message = {
                sender: `Ø¯ÙˆÙ„Ø© ${userData.countryName || userData.presidentName || "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙØ©"}`,
                sub: "Ø¹Ø±Ø¶ ØªØ¨Ø§Ø¯Ù„ ØªØ¬Ø§Ø±ÙŠ Ø¯Ø¨Ù„ÙˆÙ…Ø§Ø³ÙŠ",
                body: `**Ø¹Ø±Ø¶ Ø±Ø³Ù…ÙŠ Ù…Ù† Ø¯ÙˆÙ„ØªÙ†Ø§**\n\nÙ†Ù‚Ø¯Ù… Ù„ÙƒÙ…:\n\( {offerText}\n\nÙ†Ø·Ù„Ø¨ Ù…Ù‚Ø§Ø¨Ù„Ù‡Ø§:\n \){requestText}\n\nÙ†ØªØ·Ù„Ø¹ Ø¥Ù„Ù‰ Ø±Ø¯ÙƒÙ… Ø§Ù„Ø¥ÙŠØ¬Ø§Ø¨ÙŠ ÙÙŠ Ø£Ù‚Ø±Ø¨ ÙˆÙ‚Øª.\n\nÙ…Ø¹ Ø®Ø§Ù„Øµ Ø§Ù„ØªØ­ÙŠØ©ØŒ\nØ¯ÙŠÙˆØ§Ù† Ø§Ù„Ø±Ø¦Ø§Ø³Ø©`,
                unread: true
            };

            try {
                const targetRef = doc(db, "players", targetId);
                const targetSnap = await getDoc(targetRef);

                if (!targetSnap.exists()) {
                    return alert("Ø§Ù„Ø¯ÙˆÙ„Ø© Ø§Ù„Ù…Ø³ØªÙ‡Ø¯ÙØ© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©");
                }

                await updateDoc(targetRef, {
                    messages: [message, ...(targetSnap.data().messages || [])]
                });

                alert("âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø¯Ø¨Ù„ÙˆÙ…Ø§Ø³ÙŠ Ø¨Ù†Ø¬Ø§Ø­!");

                document.getElementById('offer-qty').value = '';
                document.getElementById('request-qty').value = '';
                document.getElementById('player-list').selectedIndex = 0;

            } catch (error) {
                console.error("Ø®Ø·Ø£:", error);
                alert("âŒ ÙØ´Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„. ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª");
            }
        };

        window.executeSpy = () => {
            alert("Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØ¬Ø³Ø³ Ù‚ÙŠØ¯ Ø§Ù„ØªØ·ÙˆÙŠØ±...");
        };

        window.closeMessage = () => {
            document.getElementById('msg-modal').style.display = 'none';
        };

        window.showTab = (id, btn) => {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(t => t.classList.remove('active'));
            document.getElementById('view-' + id).classList.add('active');
            btn.classList.add('active');
        };
    </script>
</body>
</html>