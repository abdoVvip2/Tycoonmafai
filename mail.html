<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ù„Ø¯ÙŠÙˆØ§Ù† Ø§Ù„Ù…Ù„ÙƒÙŠ | Ø§Ù„Ù…Ø±Ø§Ø³Ù„Ø§Øª Ø§Ù„Ø³ÙŠØ§Ø¯ÙŠØ©</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root { 
            --gold: #d4af37; 
            --gold-bright: #f1d592; 
            --card: rgba(22, 27, 34, 0.95); 
            --border-gold: rgba(212, 175, 55, 0.3);
            --red: #ef4444;
            --green: #22c55e;
        }
        
        body {
            margin: 0; font-family: 'Cairo', sans-serif; 
            background: #0b101b; color: #e6edf3; height: 100vh; display: flex; flex-direction: column;
        }

        .royal-header {
            padding: 20px; background: var(--card);
            border-bottom: 1px solid var(--border-gold); display: flex; justify-content: space-between; align-items: center;
        }
        .royal-header h1 { margin: 0; font-size: 1.4rem; color: var(--gold); }

        .nav-tabs { display: flex; background: rgba(0,0,0,0.5); padding: 8px; margin: 15px; border-radius: 20px; border: 1px solid var(--border-gold); }
        .tab-btn {
            flex: 1; padding: 12px; border: none; background: none; color: #8b949e;
            font-family: 'Cairo'; font-weight: bold; cursor: pointer; border-radius: 15px;
        }
        .tab-btn.active { background: var(--gold); color: #000; }

        .scroll-area { flex: 1; overflow-y: auto; padding: 0 15px 100px 15px; }
        
        .mail-card {
            background: var(--card); border: 1px solid var(--border-gold); border-radius: 20px;
            padding: 20px; margin-bottom: 16px; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        .mail-card.unread { border-right: 6px solid var(--gold); }
        .mail-card .sender { color: var(--gold-bright); font-weight: bold; }

        .luxury-box { 
            background: var(--card); border-radius: 20px; padding: 24px; 
            border: 1px solid var(--border-gold); margin-bottom: 20px;
        }
        
        select, input {
            width: 100%; padding: 14px; background: #0f172a; border: 1px solid var(--border-gold);
            border-radius: 12px; color: white; font-family: 'Cairo'; margin-bottom: 12px;
        }

        .btn-prime {
            width: 100%; padding: 16px; border: none; border-radius: 15px; 
            font-weight: 900; cursor: pointer; font-size: 1.1rem;
        }
        .btn-gold { background: var(--gold); color: #000; }
        .btn-accept { background: var(--green); color: white; margin-top: 10px; }
        .btn-reject { background: var(--red); color: white; margin-top: 10px; }

        .bottom-bar {
            position: fixed; bottom: 0; width: 100%; height: 70px;
            background: #050505; border-top: 1px solid var(--border-gold);
            display: flex; justify-content: space-around; align-items: center;
        }
        .nav-link { text-decoration: none; text-align: center; color: #666; font-size: 0.8rem; }
        .nav-link.active { color: var(--gold); }

        #msg-modal {
            position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 1000;
            display: none; align-items: center; justify-content: center; padding: 20px;
        }
        .modal-content {
            background: #161b22; width: 100%; max-width: 500px; border-radius: 25px;
            border: 2px solid var(--gold); padding: 25px; max-height: 80vh; overflow-y: auto;
        }
    </style>
</head>
<body>

    <header class="royal-header">
        <h1>ğŸ›ï¸ Ø§Ù„Ø¯ÙŠÙˆØ§Ù† Ø§Ù„Ø±Ø¦Ø§Ø³ÙŠ</h1>
        <div id="balance-display" style="color:var(--gold-bright); font-weight:bold;">$0</div>
    </header>

    <div class="nav-tabs">
        <button class="tab-btn active" onclick="showTab('inbox', this)">ğŸ“¥ Ø§Ù„ÙˆØ§Ø±Ø¯</button>
        <button class="tab-btn" onclick="showTab('actions', this)">ğŸ¤ ØªØ¨Ø§Ø¯Ù„ ØªØ¬Ø§Ø±ÙŠ</button>
    </div>

    <div class="scroll-area">
        <div id="view-inbox" class="view active">
            <div id="mail-container"></div>
        </div>

        <div id="view-actions" class="view" style="display:none;">
            <div class="luxury-box">
                <label style="color:var(--gold)">Ù†Ø­Ù† Ù†Ù‚Ø¯Ù…:</label>
                <input type="number" id="offer-qty" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ©">
                <select id="offer-res">
                    <option value="balance">ğŸ’° Ø¯ÙˆÙ„Ø§Ø±Ø§Øª</option>
                    <option value="bread">ğŸ Ø®Ø¨Ø²</option>
                    <option value="oil">ğŸ›¢ï¸ Ù†ÙØ·</option>
                    <option value="fuel">â›½ ÙˆÙ‚ÙˆØ¯</option>
                    <option value="wheat">ğŸŒ¾ Ù‚Ù…Ø­</option>
                </select>

                <label style="color:var(--gold)">Ù†Ø·Ù„Ø¨ Ù…Ù‚Ø§Ø¨Ù„Ù‡Ø§:</label>
                <input type="number" id="request-qty" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ©">
                <select id="request-res">
                    <option value="balance">ğŸ’° Ø¯ÙˆÙ„Ø§Ø±Ø§Øª</option>
                    <option value="bread">ğŸ Ø®Ø¨Ø²</option>
                    <option value="oil">ğŸ›¢ï¸ Ù†ÙØ·</option>
                    <option value="fuel">â›½ ÙˆÙ‚ÙˆØ¯</option>
                    <option value="wheat">ğŸŒ¾ Ù‚Ù…Ø­</option>
                </select>

                <label>Ø§Ù„Ø±Ø¦ÙŠØ³ Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù:</label>
                <select id="player-list"><option value="">Ø§Ø®ØªØ± Ø§Ù„Ø­Ø§ÙƒÙ…...</option></select>
                
                <button class="btn-prime btn-gold" onclick="sendTradeOffer()">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ù…ÙŠ</button>
            </div>
        </div>
    </div>

    <div id="msg-modal">
        <div class="modal-content">
            <h2 id="m-subject" style="color:var(--gold-bright)"></h2>
            <div id="m-body" style="line-height:1.6; white-space: pre-wrap;"></div>
            <div id="trade-actions" style="display:none; gap:10px; margin-top:20px;">
                <button id="btn-accept" class="btn-prime btn-accept">Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø¹Ø±Ø¶</button>
                <button id="btn-reject" class="btn-prime btn-reject" onclick="closeMessage()">Ø±ÙØ¶ ÙˆØªØ¬Ø§Ù‡Ù„</button>
            </div>
            <button class="btn-prime" onclick="closeMessage()" style="margin-top:15px; background:#333; color:white;">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
    </div>

    <div class="bottom-bar">
        <a href="consol.html" class="nav-link">ğŸ <br>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
        <a href="mail.html" class="nav-link active">ğŸ“©<br>Ø§Ù„Ø¨Ø±ÙŠØ¯</a>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, updateDoc, collection, getDocs, onSnapshot, arrayUnion } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDIxOZ_zEKosBgJD2Thn038BFpM25rVGcc",
            authDomain: "tycoon-c3b89.firebaseapp.com",
            projectId: "tycoon-c3b89",
            storageBucket: "tycoon-c3b89.firebasestorage.app",
            messagingSenderId: "534437445544",
            appId: "1:534437445544:web:5f7ea5396367e6b5cca79d"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        let userRef, userData, allPlayers = [];

        const resNames = { balance: "ğŸ’° Ø¯ÙˆÙ„Ø§Ø±Ø§Øª", bread: "ğŸ Ø®Ø¨Ø²", oil: "ğŸ›¢ï¸ Ù†ÙØ·", fuel: "â›½ ÙˆÙ‚ÙˆØ¯", wheat: "ğŸŒ¾ Ù‚Ù…Ø­" };

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userRef = doc(db, "players", user.uid);
                onSnapshot(userRef, (snap) => {
                    userData = snap.data();
                    document.getElementById('balance-display').innerText = "$" + (userData.balance || 0).toLocaleString();
                    renderMails();
                });
                loadPlayers();
            }
        });

        async function loadPlayers() {
            const snap = await getDocs(collection(db, "players"));
            const list = document.getElementById('player-list');
            snap.forEach(d => {
                if(d.id !== auth.currentUser.uid) {
                    let opt = document.createElement('option');
                    opt.value = d.id;
                    opt.innerText = d.data().countryName || d.data().presidentName;
                    list.appendChild(opt);
                }
            });
        }

        function renderMails() {
            const cont = document.getElementById('mail-container');
            cont.innerHTML = "";
            if (!userData.messages) return;

            userData.messages.slice().reverse().forEach((m, i) => {
                let card = document.createElement('div');
                card.className = `mail-card ${m.unread ? 'unread' : ''}`;
                card.onclick = () => openMessage(userData.messages.length - 1 - i);
                card.innerHTML = `<span class="sender">${m.sender}</span><br>${m.sub}`;
                cont.appendChild(card);
            });
        }

        window.openMessage = (idx) => {
            const m = userData.messages[idx];
            document.getElementById('m-subject').innerText = m.sub;
            document.getElementById('m-body').innerText = m.body;
            document.getElementById('msg-modal').style.display = 'flex';
            
            const tradeBox = document.getElementById('trade-actions');
            if (m.type === 'trade' && !m.processed) {
                tradeBox.style.display = 'flex';
                document.getElementById('btn-accept').onclick = () => acceptTrade(idx);
            } else {
                tradeBox.style.display = 'none';
            }
        };

        window.sendTradeOffer = async () => {
            const targetId = document.getElementById('player-list').value;
            const oQty = parseInt(document.getElementById('offer-qty').value);
            const oRes = document.getElementById('offer-res').value;
            const rQty = parseInt(document.getElementById('request-qty').value);
            const rRes = document.getElementById('request-res').value;

            if (!targetId || !oQty || !rQty) return alert("Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
            if (userData[oRes] < oQty) return alert("Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ù…Ø§ ÙŠÙƒÙÙŠ Ù…Ù† " + resNames[oRes]);

            const msg = {
                sender: userData.countryName,
                senderId: auth.currentUser.uid,
                sub: "ğŸ¤ Ø¹Ø±Ø¶ ØªØ¨Ø§Ø¯Ù„ ØªØ¬Ø§Ø±ÙŠ",
                body: `ØªØ¹Ø±Ø¶ Ø¹Ù„ÙŠÙƒÙ… Ø¯ÙˆÙ„Ø© ${userData.countryName}:\nØªÙ‚Ø¯ÙŠÙ…: ${oQty} Ù…Ù† ${resNames[oRes]}\nÙ…Ù‚Ø§Ø¨Ù„: ${rQty} Ù…Ù† ${resNames[rRes]}`,
                type: 'trade',
                oRes, oQty, rRes, rQty,
                unread: true,
                processed: false
            };

            await updateDoc(doc(db, "players", targetId), { messages: arrayUnion(msg) });
            alert("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¹Ø±Ø¶!");
        };

        async function acceptTrade(idx) {
            const m = userData.messages[idx];
            if (userData[m.rRes] < m.rQty) return alert("Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ù…Ø§ ÙŠÙƒÙÙŠ Ù„Ù„Ù‚Ø¨ÙˆÙ„!");

            const senderRef = doc(db, "players", m.senderId);
            const senderSnap = await getDoc(senderRef);
            const senderData = senderSnap.data();

            if (senderData[m.oRes] < m.oQty) return alert("Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø± Ù„Ù… ÙŠØ¹Ø¯ ÙŠÙ…Ù„Ùƒ Ø§Ù„Ù…ÙˆØ§Ø±Ø¯!");

            // Ø®ØµÙ… ÙˆØ§Ø¶Ø§ÙØ© Ù„Ù„Ù…Ø³ØªÙ„Ù… (Ø£Ù†Øª)
            let myUpdate = { messages: userData.messages };
            myUpdate[m.rRes] = userData[m.rRes] - m.rQty;
            myUpdate[m.oRes] = (userData[m.oRes] || 0) + m.oQty;
            myUpdate.messages[idx].processed = true;
            myUpdate.messages[idx].body += "\n\nâœ… ØªÙ… Ù‚Ø¨ÙˆÙ„ Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø±Ø¶ Ø¨Ù†Ø¬Ø§Ø­.";

            // Ø®ØµÙ… ÙˆØ§Ø¶Ø§ÙØ© Ù„Ù„Ù…Ø±Ø³Ù„
            let hisUpdate = {};
            hisUpdate[m.oRes] = senderData[m.oRes] - m.oQty;
            hisUpdate[m.rRes] = (senderData[m.rRes] || 0) + m.rQty;

            await updateDoc(userRef, myUpdate);
            await updateDoc(senderRef, hisUpdate);
            
            alert("ØªÙ…Øª Ø§Ù„ØµÙÙ‚Ø© Ø¨Ù†Ø¬Ø§Ø­!");
            closeMessage();
        }

        window.showTab = (id, btn) => {
            document.querySelectorAll('.view').forEach(v => v.style.display = 'none');
            document.querySelectorAll('.tab-btn').forEach(t => t.classList.remove('active'));
            document.getElementById('view-' + id).style.display = 'block';
            btn.classList.add('active');
        };

        window.closeMessage = () => document.getElementById('msg-modal').style.display = 'none';
    </script>
</body>
</html>
